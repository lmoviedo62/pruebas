{% extends "base.html" %}
{% block title %}Recuperar contrase√±a{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-body p-4 p-md-5">
                <div class="text-center mb-4">
                    <div class="mb-3">
                        <span style="font-size: 48px;">üîí</span>
                    </div>
                    <h1 class="text-center mb-3 text-serena fw-bold">¬øOlvidaste tu contrase√±a?</h1>
                    <p class="text-center text-muted mb-4">
                        No te preocupes, te ayudaremos a recuperarla. Ingresa tu correo institucional 
                        y te enviaremos un enlace seguro para restablecer tu contrase√±a.
                    </p>
                </div>

                <div class="alert alert-info mb-4" style="background-color: #f0f4ff; border-left: 4px solid #7b2ff7; border-radius: 8px;">
                    <small>
                        <strong>üìß ¬øC√≥mo funciona?</strong><br>
                        El enlace de recuperaci√≥n ser√° v√°lido por 1 hora. Revisa tu bandeja de entrada y tu carpeta de spam.
                    </small>
                </div>

                <form id="forgot-password-form">
                    <div class="mb-3">
                        <label class="form-label">Correo institucional</label>
                        <input type="email" class="form-control" id="forgot-email"
                               placeholder="usuario@ucatolica.edu.co" required
                               pattern=".+@ucatolica\.edu\.co">
                        <div class="form-text">Debe ser un correo @ucatolica.edu.co</div>
                    </div>

                    <div id="message-box" class="alert" style="display: none;"></div>

                    <div class="d-grid gap-2 mb-3">
                        <button type="submit" class="btn btn-serena" id="submit-btn">
                            üì® Enviar enlace de recuperaci√≥n
                        </button>
                        <a href="/login" class="btn btn-outline-secondary">
                            ‚Üê Volver al inicio de sesi√≥n
                        </a>
                    </div>
                </form>

                <div class="text-center mt-3">
                    <a href="/" class="text-serena fw-semibold text-decoration-none">Volver a la p√°gina principal</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.text-serena {
    color: #7b2ff7;
}
.btn-serena {
    background-color: #7b2ff7;
    border-color: #7b2ff7;
    color: #fff;
}
.btn-serena:hover {
    background-color: #5f22bd;
    border-color: #5f22bd;
    color: #fff;
}
.btn-serena:disabled {
    background-color: #b19bdb;
    border-color: #b19bdb;
    cursor: not-allowed;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("forgot-password-form");
    const messageBox = document.getElementById("message-box");
    const submitBtn = document.getElementById("submit-btn");
    const emailInput = document.getElementById("forgot-email");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        messageBox.style.display = "none";
        
        const email = emailInput.value.trim();

        // Validar que sea correo institucional
        if (!email.endsWith("@ucatolica.edu.co")) {
            messageBox.className = "alert alert-danger";
            messageBox.innerHTML = "‚ùå El correo debe ser institucional (@ucatolica.edu.co)";
            messageBox.style.display = "block";
            return;
        }
        
        // Deshabilitar bot√≥n mientras se procesa
        submitBtn.disabled = true;
        submitBtn.innerHTML = "‚è≥ Enviando...";
        
        try {
            const resp = await fetch(`/api/v1/auth/forgot-password?email=${encodeURIComponent(email)}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });
            
            const data = await resp.json();
            
            if (resp.ok) {
                messageBox.className = "alert alert-success";
                messageBox.innerHTML = `
                    <strong>‚úÖ ¬°Correo enviado!</strong><br>
                    ${data.message || 'Revisa tu bandeja de entrada y tu carpeta de spam.'}
                `;
                messageBox.style.display = "block";
                form.reset();
            } else {
                messageBox.className = "alert alert-danger";
                messageBox.innerHTML = `
                    <strong>‚ùå Error</strong><br>
                    ${data.detail || "Error al solicitar recuperaci√≥n"}
                `;
                messageBox.style.display = "block";
            }
        } catch (err) {
            console.error(err);
            messageBox.className = "alert alert-danger";
            messageBox.innerHTML = `
                <strong>‚ùå Error de conexi√≥n</strong><br>
                No se pudo conectar con el servidor. Verifica tu conexi√≥n e intenta nuevamente.
            `;
            messageBox.style.display = "block";
        } finally {
            // Rehabilitar bot√≥n
            submitBtn.disabled = false;
            submitBtn.innerHTML = "üì® Enviar enlace de recuperaci√≥n";
        }
    });
});
</script>
{% endblock %}