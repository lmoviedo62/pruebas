<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro en Serena</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #ffffff;
    }

    .top-bar {
      width: 100%;
      background: #908bdb;
      color: #ffffff;
      padding: 14px 0;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
    }

    .top-bar-inner {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .top-bar-title {
      font-weight: 700;
      font-size: 18px;
    }

    .top-bar-links {
      font-size: 14px;
      display: flex;
      gap: 16px;
    }

    .top-bar-links a {
      color: #f9fafb;
      text-decoration: none;
    }

    .top-bar-links a:hover {
      text-decoration: underline;
    }

    .page {
      width: 100%;
      max-width: 900px;
      padding: 24px 20px 40px;
      margin: 0 auto;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      padding: 32px 40px 36px;
    }

    h1 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 28px;
      color: #1f2933;
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 24px;
    }

    form {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px 24px;
    }

    .full-row {
      grid-column: 1 / -1;
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      color: #374151;
      font-weight: 500;
    }

    input,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input:focus,
    select:focus {
      border-color: #908bdb;
      box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.15);
    }

    input.error {
      border-color: #dc2626;
    }

    input.success {
      border-color: #10b981;
    }

    small {
      font-size: 11px;
      color: #6b7280;
      display: block;
      margin-top: 4px;
    }

    small.error {
      color: #dc2626;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      font-size: 13px;
      color: #4b5563;
      padding-top: 4px;
      line-height: 1.4;
    }

    .checkbox-row input[type="checkbox"] {
      margin: 0;
      width: auto;
    }

    #registroError {
      grid-column: 1 / -1;
      color: #dc2626;
      font-size: 13px;
      text-align: center;
    }

    .btn-submit {
      grid-column: 1 / -1;
      margin-top: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #8b5cf6, #908bdb);
      color: #ffffff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s ease;
    }

    .btn-submit:hover {
      opacity: 0.95;
      box-shadow: 0 10px 24px rgba(148, 27, 147, 0.35);
      transform: translateY(-1px);
    }

    .btn-submit:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    @media (max-width: 720px) {
      .card {
        padding: 20px 18px 24px;
      }

      form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-bar-inner">
      <div class="top-bar-title">Serena</div>
      <div class="top-bar-links">
        <a href="/">Ingresar</a>
        <a href="/register">Registro</a>
      </div>
    </div>
  </div>

  <div class="page">
    <div class="card">
      <h1>Registro en Serena</h1>
      <p class="subtitle">
        Completa tus datos para acceder al chatbot, diario personal y servicios de ayuda emocional.
      </p>

      <form id="registroForm">
        <!-- Correo institucional -->
        <div class="full-row">
          <label for="email">Correo institucional</label>
          <input
            id="email"
            name="email"
            type="email"
            required
            placeholder="usuario@ucatolica.edu.co"
            pattern="^[a-zA-Z0-9._%+-]+@ucatolica\.edu\.co$"
          />
          <small id="email-error" class="error"></small>
        </div>

        <!-- Identificación -->
        <div>
          <label for="identificacion">Identificación (ID)</label>
          <input
            id="identificacion"
            name="identificacion"
            type="text"
            inputmode="numeric"
            pattern="^[0-9]+$"
            required
            placeholder="Solo números"
          />
          <small id="id-error" class="error"></small>
        </div>

        <!-- Nombre -->
        <div>
          <label for="nombre">Nombre</label>
          <input
            id="nombre"
            name="nombre"
            type="text"
            required
            pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$"
            placeholder="Solo letras"
          />
          <small id="nombre-error" class="error"></small>
        </div>

        <!-- Apellido -->
        <div>
          <label for="apellido">Apellido</label>
          <input
            id="apellido"
            name="apellido"
            type="text"
            required
            pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$"
            placeholder="Solo letras"
          />
          <small id="apellido-error" class="error"></small>
        </div>

        <!-- Programa / Carrera -->
        <div>
          <label for="programa">Programa / Carrera</label>
          <select id="programa" name="programa" required>
            <option value="">Selecciona…</option>
            <option value="Administración de Empresas e Inteligencia de Negocios">
              Administración de Empresas e Inteligencia de Negocios
            </option>
            <option value="Derecho">Derecho</option>
            <option value="Economía">Economía</option>
            <option value="Ingeniería Civil">Ingeniería Civil</option>
            <option value="Arquitectura">Arquitectura</option>
            <option value="Ingeniería Industrial">Ingeniería Industrial</option>
            <option value="Ingeniería de Sistemas y Computación">
              Ingeniería de Sistemas y Computación
            </option>
            <option value="Psicología">Psicología</option>
          </select>
        </div>

        <!-- Semestre -->
        <div>
          <label for="semestre">Semestre</label>
          <select id="semestre" name="semestre" required>
            <option value="">…</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
        </div>

        <!-- Teléfono -->
        <div>
          <label for="telefono">Teléfono</label>
          <input
            id="telefono"
            name="telefono"
            type="text"
            inputmode="numeric"
            minlength="10"
            maxlength="10"
            pattern="^[0-9]{10}$"
            required
            placeholder="10 dígitos"
          />
          <small id="tel-error" class="error"></small>
        </div>

        <!-- Contraseña -->
        <div class="full-row">
          <label for="password">Contraseña</label>
          <input
            id="password"
            name="password"
            type="password"
            required
            minlength="8"
            placeholder="Mínimo 8 caracteres"
          />
          <small id="pass-error">Mínimo 8 caracteres, mezcla letras, números y caracteres especiales.</small>
        </div>

        <!-- Autorización datos -->
        <div class="full-row">
          <label class="checkbox-row">
            <input
              id="acepto_datos"
              name="acepto_datos"
              type="checkbox"
              required
            />
            <span>
              Autorizo el tratamiento de mis datos según la
              <a href="/politica-privacidad" target="_blank">política de privacidad</a>.
            </span>
          </label>
        </div>

        <p id="registroError"></p>

        <button type="submit" class="btn-submit" id="btnSubmit">Registrarme</button>
      </form>
    </div>
  </div>

  <script>
    // ============ VALIDACIONES EN TIEMPO REAL ============
    
    const emailInput = document.getElementById("email");
    const emailError = document.getElementById("email-error");
    
    const idInput = document.getElementById("identificacion");
    const idError = document.getElementById("id-error");
    
    const nombreInput = document.getElementById("nombre");
    const nombreError = document.getElementById("nombre-error");
    
    const apellidoInput = document.getElementById("apellido");
    const apellidoError = document.getElementById("apellido-error");
    
    const telInput = document.getElementById("telefono");
    const telError = document.getElementById("tel-error");
    
    const passInput = document.getElementById("password");
    const passError = document.getElementById("pass-error");

    // Validar EMAIL - Solo @ucatolica.edu.co
    emailInput.addEventListener("blur", function() {
      const regex = /^[a-zA-Z0-9._%+-]+@ucatolica\.edu\.co$/;
      if (!regex.test(this.value)) {
        emailError.textContent = "Debe ser correo institucional @ucatolica.edu.co";
        this.classList.add("error");
        this.classList.remove("success");
      } else {
        emailError.textContent = "";
        this.classList.remove("error");
        this.classList.add("success");
      }
    });

    // Validar IDENTIFICACIÓN - Solo números
    idInput.addEventListener("input", function() {
      this.value = this.value.replace(/[^0-9]/g, "");
      if (this.value.length > 0 && this.value.length < 6) {
        idError.textContent = "Mínimo 6 dígitos";
        this.classList.add("error");
      } else {
        idError.textContent = "";
        this.classList.remove("error");
        if (this.value.length >= 6) this.classList.add("success");
      }
    });

    // Validar NOMBRE - Solo letras
    nombreInput.addEventListener("input", function() {
      this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, "");
      if (this.value.length > 0 && this.value.length < 2) {
        nombreError.textContent = "Mínimo 2 letras";
        this.classList.add("error");
      } else {
        nombreError.textContent = "";
        this.classList.remove("error");
        if (this.value.length >= 2) this.classList.add("success");
      }
    });

    // Validar APELLIDO - Solo letras
    apellidoInput.addEventListener("input", function() {
      this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, "");
      if (this.value.length > 0 && this.value.length < 2) {
        apellidoError.textContent = "Mínimo 2 letras";
        this.classList.add("error");
      } else {
        apellidoError.textContent = "";
        this.classList.remove("error");
        if (this.value.length >= 2) this.classList.add("success");
      }
    });

    // Validar TELÉFONO - Solo 10 dígitos
    telInput.addEventListener("input", function() {
      this.value = this.value.replace(/[^0-9]/g, "").slice(0, 10);
      if (this.value.length > 0 && this.value.length < 10) {
        telError.textContent = `Faltan ${10 - this.value.length} dígitos`;
        this.classList.add("error");
      } else if (this.value.length === 10) {
        telError.textContent = "";
        this.classList.remove("error");
        this.classList.add("success");
      }
    });

    // Validar CONTRASEÑA - Mínimo 8 caracteres con letras, números y especiales
    passInput.addEventListener("input", function() {
      const hasLetter = /[a-zA-Z]/.test(this.value);
      const hasNumber = /[0-9]/.test(this.value);
      const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(this.value);
      const isLongEnough = this.value.length >= 8;

      if (!isLongEnough) {
        passError.textContent = "Mínimo 8 caracteres";
        passError.classList.add("error");
        this.classList.add("error");
      } else if (!hasLetter || !hasNumber || !hasSpecial) {
        passError.textContent = "Debe incluir letras, números y caracteres especiales";
        passError.classList.add("error");
        this.classList.add("error");
      } else {
        passError.textContent = "✓ Contraseña segura";
        passError.classList.remove("error");
        this.classList.remove("error");
        this.classList.add("success");
      }
    });

    // ============ ENVÍO DEL FORMULARIO ============
    
    const form = document.getElementById("registroForm");
    const errorBox = document.getElementById("registroError");
    const btnSubmit = document.getElementById("btnSubmit");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorBox.textContent = "";

      // Validación final antes de enviar
      const email = emailInput.value.trim();
      const identificacion = idInput.value.trim();
      const nombre = nombreInput.value.trim();
      const apellido = apellidoInput.value.trim();
      const telefono = telInput.value.trim();
      const password = passInput.value;
      const programa = document.getElementById("programa").value;
      const semestre = document.getElementById("semestre").value;

      // Validar correo
      if (!email.endsWith("@ucatolica.edu.co")) {
        errorBox.textContent = "El correo debe ser institucional @ucatolica.edu.co";
        emailInput.focus();
        return;
      }

      // Validar identificación
      if (!/^[0-9]{6,}$/.test(identificacion)) {
        errorBox.textContent = "La identificación debe tener mínimo 6 dígitos numéricos";
        idInput.focus();
        return;
      }

      // Validar nombre
      if (!/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]{2,}$/.test(nombre)) {
        errorBox.textContent = "El nombre solo debe contener letras";
        nombreInput.focus();
        return;
      }

      // Validar apellido
      if (!/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]{2,}$/.test(apellido)) {
        errorBox.textContent = "El apellido solo debe contener letras";
        apellidoInput.focus();
        return;
      }

      // Validar teléfono
      if (!/^[0-9]{10}$/.test(telefono)) {
        errorBox.textContent = "El teléfono debe tener exactamente 10 dígitos";
        telInput.focus();
        return;
      }

      // Validar contraseña
      const hasLetter = /[a-zA-Z]/.test(password);
      const hasNumber = /[0-9]/.test(password);
      const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
      
      if (password.length < 8) {
        errorBox.textContent = "La contraseña debe tener mínimo 8 caracteres";
        passInput.focus();
        return;
      }
      
      if (!hasLetter || !hasNumber || !hasSpecial) {
        errorBox.textContent = "La contraseña debe incluir letras, números y caracteres especiales";
        passInput.focus();
        return;
      }

      // Validar checkbox
      if (!document.getElementById("acepto_datos").checked) {
        errorBox.textContent = "Debes aceptar la política de privacidad";
        return;
      }

      // Deshabilitar botón mientras se procesa
      btnSubmit.disabled = true;
      btnSubmit.textContent = "Registrando...";

      // Preparar datos para enviar
      const payload = {
        email: email,
        full_name: `${nombre} ${apellido}`,
        password: password,
        identificacion: identificacion,
        nombre: nombre,
        apellido: apellido,
        programa: programa,
        semestre: parseInt(semestre),
        telefono: telefono
      };

      try {
        const resp = await fetch("/api/v1/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await resp.json();

        if (!resp.ok) {
          errorBox.textContent = data.detail || "Error al registrarse. Por favor intenta de nuevo.";
          btnSubmit.disabled = false;
          btnSubmit.textContent = "Registrarme";
          return;
        }

        // Registro exitoso
        alert("¡Registro exitoso! Ahora serás redirigido al panel.");
        window.location.href = "/panel";
        
      } catch (err) {
        console.error("Error completo:", err);
        errorBox.textContent = "Error de conexión con el servidor. Por favor intenta de nuevo.";
        btnSubmit.disabled = false;
        btnSubmit.textContent = "Registrarme";
      }
    });
  </script>
</body>
</html>